select PRODUCT, REGION, PRODUCT_CODE_REGION, LISTAGG(PAR_DATE_REGION1) WITHIN GROUP (ORDER BY PAR_DATE_REGION1) "PAR_DATE_REGION1", LISTAGG(PAR_DATE_REGION2) WITHIN GROUP (ORDER BY PAR_DATE_REGION2) "PAR_DATE_REGION2", LISTAGG(PAR_DATE_REGION3) WITHIN GROUP (ORDER BY PAR_DATE_REGION3) "PAR_DATE_REGION3",
sum(nvl(TARGET_CLTS_REGION1,0)) TARGET_CLTS_REGION1, sum(nvl(TARGET_CLTS_REGION2,0)) TARGET_CLTS_REGION2, sum(nvl(TARGET_CLTS_REGION3,0)) TARGET_CLTS_REGION3,
sum(nvl(ACHIEVEMENT_CLTS_REGION1,0)) ACHIEVEMENT_CLTS_REGION1, sum(nvl(ACHIEVEMENT_CLTS_REGION2,0)) ACHIEVEMENT_CLTS_REGION2, sum(nvl(ACHIEVEMENT_CLTS_REGION3,0)) ACHIEVEMENT_CLTS_REGION3
from
(
select PRODUCT, REGION, PRODUCT_CODE_REGION,

case when to_char(trunc((trunc(to_date(:asOfDate, 'dd-MM-yyyy'),'month')-1),'month')-1,'RRRRMM') = FLAG_REGION1 then TARGET_CLTS_REGION end as TARGET_CLTS_REGION1,
case when to_char(trunc(to_date(:asOfDate, 'dd-MM-yyyy'),'month')-1,'RRRRMM') = FLAG_REGION1 then TARGET_CLTS_REGION end as TARGET_CLTS_REGION2,
case when to_char(to_date(:asOfDate, 'dd-MM-yyyy'),'RRRRMM') = FLAG_REGION1 then TARGET_CLTS_REGION end as TARGET_CLTS_REGION3,

case when to_char(trunc((trunc(to_date(:asOfDate, 'dd-MM-yyyy'),'month')-1),'month')-1,'RRRRMM') = FLAG_REGION1 then ACHIEVEMENT_CLTS_REGION end as ACHIEVEMENT_CLTS_REGION1,
case when to_char(trunc(to_date(:asOfDate, 'dd-MM-yyyy'),'month')-1,'RRRRMM') = FLAG_REGION1 then ACHIEVEMENT_CLTS_REGION end as ACHIEVEMENT_CLTS_REGION2,
case when to_char(to_date(:asOfDate, 'dd-MM-yyyy'),'RRRRMM') = FLAG_REGION1 then ACHIEVEMENT_CLTS_REGION end as ACHIEVEMENT_CLTS_REGION3,

case when to_char(trunc((trunc(to_date(:asOfDate, 'dd-MM-yyyy'),'month')-1),'month')-1,'RRRRMM') = FLAG_REGION1 then PAR_DATE_REGION end as PAR_DATE_REGION1,
case when to_char(trunc(to_date(:asOfDate, 'dd-MM-yyyy'),'month')-1,'RRRRMM') =  FLAG_REGION1 then PAR_DATE_REGION end as PAR_DATE_REGION2,
case when to_char(to_date(:asOfDate, 'dd-MM-yyyy'),'RRRRMM') =  FLAG_REGION1 then PAR_DATE_REGION end as PAR_DATE_REGION3

from
(
SELECT DISTINCT INITCAP(PD.PRD_GRP_NM) PRODUCT, INITCAP(R.REG_NM) REGION, 

SUM(NVL(TA.TARGET_AMT,0)) TARGET_CLTS_REGION, SUM(NVL(TA.ACH_AMT,0)) ACHIEVEMENT_CLTS_REGION, 
(CASE WHEN (SUM(NVL(TA.TARGET_AMT,0)) > 0 AND  SUM(NVL(TA.ACH_AMT,0)) > 0) THEN  ROUND(SUM(NVL(TA.ACH_AMT,0)) / SUM(NVL(TA.TARGET_AMT,0)) * 100,2) ELSE 0 END) P_TAG_CLTS_REGION,

TO_CHAR(TA.PAR_DATE,'Mon-YYYY') PAR_DATE_REGION,
TO_NUMBER(TO_CHAR(TA.PAR_DATE,'MM')) FLAG_REGION,
to_number(TO_CHAR(TA.PAR_DATE,'RRRRMM')) FLAG_REGION1,
(CASE WHEN PD.PRD_GRP_SEQ = 1 THEN 1
     WHEN PD.PRD_GRP_SEQ = 13 THEN 2
     WHEN PD.PRD_GRP_SEQ = 6 THEN 3
     WHEN PD.PRD_GRP_SEQ = 9 THEN 4
     WHEN PD.PRD_GRP_SEQ = 4 THEN 5
     WHEN PD.PRD_GRP_SEQ = 10 THEN 6
     WHEN PD.PRD_GRP_SEQ = 5 THEN 7
     WHEN PD.PRD_GRP_SEQ = 11 THEN 8
     WHEN PD.PRD_GRP_SEQ = 8 THEN 9
     ELSE PD.PRD_GRP_SEQ
  END)  PRODUCT_CODE_REGION
FROM KASHF_REPORTING.TARGET_ACHIEVEMENTS TA, MW_BRNCH B, MW_AREA A, MW_REG R, MW_PRD_GRP PD
WHERE TA.BRANCH_CD = B.BRNCH_CD AND B.CRNT_REC_FLG = 1
AND B.AREA_SEQ = A.AREA_SEQ AND A.CRNT_REC_FLG = 1
AND A.REG_SEQ = R.REG_SEQ AND R.CRNT_REC_FLG = 1
AND TA.PRODUCT_CODE = PD.PRD_GRP_SEQ AND PD.CRNT_REC_FLG = 1
AND  TA.PRODUCT_CODE not in (8,4,5,11,10)
--and b.brnch_seq = 1
AND TO_CHAR(TA.PAR_DATE,'MM') BETWEEN (TO_NUMBER(TO_CHAR(TO_DATE(:asOfDate, 'dd-MM-yyyy'),'MM'))- 2) AND TRIM(TO_NUMBER(TO_CHAR(TO_DATE(:asOfDate, 'dd-MM-yyyy'),'MM')))
GROUP BY PD.PRD_GRP_NM,TO_CHAR(TA.PAR_DATE,'Mon-YYYY'), INITCAP(R.REG_NM), PD.PRD_GRP_SEQ,TO_NUMBER(TO_CHAR(TA.PAR_DATE,'MM')), to_number(TO_CHAR(TA.PAR_DATE,'RRRRMM')) 
ORDER BY PRODUCT_CODE_REGION,TO_CHAR(TA.PAR_DATE,'Mon-YYYY'), INITCAP(R.REG_NM))
)
group by PRODUCT, REGION, PRODUCT_CODE_REGION
order by PRODUCT_CODE_REGION, PRODUCT, REGION